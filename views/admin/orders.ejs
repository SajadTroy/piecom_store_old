<div class="admin-container">
    <div class="page-header">
        <h2>Orders</h2>
    </div>

    <div class="tabs-container">
        <div class="tabs">
            <button class="tab-button active" data-status="all">All Orders</button>
            <button class="tab-button" data-status="delivered">Delivered</button>
            <button class="tab-button" data-status="shipped">Shipped</button>
            <button class="tab-button" data-status="cancelled">Cancelled</button>
        </div>

        <div class="table-card">
            <% if (orders && orders.length> 0) { %>
                <div class="table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Products</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <% orders.forEach(order=> { %>
                                <tr data-status="<%= order.deliveryStatus ? order.deliveryStatus.toLowerCase() : 'unknown' %>">
                                    <td>#<%= String(order._id).slice(-6) %></td>
                                    <td>
                                        <%= order.userId.email %>
                                    </td>
                                    <td>
                                        <%= order.products.length %> items
                                    </td>
                                    <td>â‚¹<%= order.totalPrice %>
                                    </td>
                                    <td>
                                        <select class="status-select" data-id="<%= order._id %>">
                                            <option value="Shipped" <%=order.deliveryStatus==='Shipped' ? 'selected'
                                                : '' %>>Shipped</option>
                                            <option value="Delivered" <%=order.deliveryStatus==='Delivered' ? 'selected'
                                                : '' %>>Delivered</option>
                                            <option value="Cancelled" <%=order.deliveryStatus==='Cancelled' ? 'selected'
                                                : '' %>>Cancelled</option>
                                        </select>
                                    </td>
                                    <td>
                                        <%= new Date(order.createdAt).toLocaleDateString() %>
                                    </td>
                                    <td>
                                        <button class="view-details" data-id="<%= order._id %>">
                                            <svg width="18" height="18" fill="none" stroke="currentColor"
                                                stroke-width="1.5" viewBox="0 0 24 24">
                                                <path d="M2 12s3.636-7 10-7 10 7 10 7-3.636 7-10 7-10-7-10-7Z" />
                                                <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" />
                                            </svg>
                                        </button>
                                    </td>
                                </tr>
                                <% }) %>
                        </tbody>
                    </table>
                </div>
                <% } else { %>
                    <div class="no-data">
                        <svg width="64" height="64" fill="none" stroke="currentColor" stroke-width="1.5"
                            viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"
                            xmlns="http://www.w3.org/2000/svg">
                            <path
                                d='m12 21 8.131-4.208c.316-.164.474-.245.589-.366a1 1 0 0 0 .226-.373c.054-.159.054-.336.054-.692V7.533M12 21l-8.131-4.208c-.316-.164-.474-.245-.589-.366a1 1 0 0 1-.226-.373C3 15.894 3 15.716 3 15.359V7.533M12 21v-9.063m9-4.404-9 4.404m9-4.404-4.5-2.33M3 7.534l8.269-4.28c.268-.138.401-.208.542-.235a1 1 0 0 1 .378 0c.14.027.274.097.541.235l3.77 1.95M3 7.534l4.5 2.202m4.5 2.202L7.5 9.735m0 0 9-4.531m-9 4.531v2.202' />
                        </svg>
                        <p>No orders available</p>
                    </div>
                    <% } %>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tabButtons = document.querySelectorAll('.tab-button');
        const orderRows = document.querySelectorAll('#ordersTableBody tr');
        const statusSelects = document.querySelectorAll('.status-select');

        // Tab filtering
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const status = button.dataset.status;

                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                orderRows.forEach(row => {
                    if (status === 'all' || row.dataset.status === status) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        });

        // Status update
        statusSelects.forEach(select => {
            select.addEventListener('change', async function () {
                const orderId = this.dataset.id;
                const newStatus = this.value;

                try {
                    const response = await fetch(`/admin/orders/${orderId}/status`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: newStatus })
                    });

                    if (response.ok) {
                        const row = this.closest('tr');
                        row.dataset.status = newStatus.toLowerCase();
                        // Refresh the current tab view
                        document.querySelector('.tab-button.active').click();
                    }
                } catch (error) {
                    alert('Error updating order status');
                }
            });
        });
    });
</script>